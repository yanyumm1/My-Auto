name: ğŸª„ XServer è‡ªåŠ¨ç­¾åˆ°ï¼ˆç§åº“ç‰ˆï¼‰

on:
  schedule:
    # UTC 00:15 & 12:15
    # å¯¹åº”åŒ—äº¬æ—¶é—´ 08:15 & 20:15
    - cron: "15 0,12 * * *"
  workflow_dispatch:

permissions:
  contents: write   # âš ï¸ å¿…é¡»åŠ ï¼Œå¦åˆ™ push ä¼šè¢«æ‹’ç»

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # âœ… æ£€å‡ºç§åº“ xserver
      - name: Checkout private repo (xserver)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/xserver
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: scripts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # â±ï¸ pip + playwright ç¼“å­˜
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        working-directory: scripts
        run: |
          pip install -r requirements.txt -q
          python -m playwright install chromium

      # ğŸ² é˜²æ­¢å®šæ—¶ä»»åŠ¡æ’ç‚¹
      - name: Random delay (0-119s)
        run: |
          delay=$((RANDOM % 120))
          echo "Random delay: ${delay}s"
          sleep $delay

      # â–¶ï¸ æ‰§è¡Œç»­æœŸè„šæœ¬
      - name: Run renew script
        working-directory: scripts
        env:
          XSERVER_EMAIL: ${{ secrets.XSERVER_EMAIL }}
          XSERVER_PASSWORD: ${{ secrets.XSERVER_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PROXY_SERVER: ${{ secrets.PROXY_SERVER }}
          HEADLESS: "true"
        run: python renew.py

      # ğŸš€ æäº¤å¹¶æ¨é€åˆ°ç§åº“
      - name: Commit & push changes
        if: success()
        working-directory: scripts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md time.txt

          git commit -m "chore: auto check-in update [skip ci]" \
            && git push || echo "Nothing to push"

      